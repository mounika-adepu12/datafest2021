---
title: "Jenny_Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r eval=FALSE}
library(usethis)
use_git_config(user.name= "JennyHuang19", user.email="yjh3@duke.edu")
```


```{r}
install.packages("reticulate")
library(readr)
library(tidyverse)
library(broom)
library(knitr)
library(patchwork)
library(rms)
library(reticulate)

#install.packages("skimr")
library(skimr)
install.packages("DataExplorer")
library(DataExplorer)
#install.packages("dlookr")
#library(dlookr)
```

```{r}
us <- read_csv("df_data/US/us_19.csv")
```

We start out with 29873 rows and 523 columns.

```{r}
# identify missing entires for each variable and plot dist of each variable
skim(us)
```

```{r}
#select numeric variables
numeric <- us %>% 
  select(where(is.numeric))

glimpse(numeric)
```

```{r}

```


```{r}
# summary stats for numeric variables
numeric_of_intrst <- us %>% 
  select(DEM_GENDER, DEM_AGE, WT, DEM_INCOME, DEM_REGION,
         DEM_GENHEALTH, ORDER_SED, DEM_EDU, DEM_PREG, DEM_EDU, DEM_MARITAL, DEM_STDNT, STIM_USE, STIM_NMU) %>% 
  mutate(DEM_GENDER = factor(DEM_GENDER),
         DEM_PREG = factor(DEM_PREG),
         DEM_GENHEALTH = factor(DEM_GENHEALTH),
         DEM_STDNT = factor(DEM_STDNT),
         DEM_EDU = factor(DEM_EDU),
         STIM_USE = factor(STIM_USE),
         STIM_NMU = factor(STIM_NMU))

# describe(numeric_of_intrst)
```

```{r}
# histogram of numeric variables
plot_histogram(numeric_of_intrst)
```


```{r}
ggplot(numeric_of_intrst, aes(x=DEM_GENDER)) + 
  geom_bar(fill = "turquoise") +
  theme_bw() +
  labs(title = "Distribution of Age")
```

```{r}
ggplot(numeric_of_intrst, aes(x=DEM_STDNT)) + 
  geom_bar(fill = "turquoise") +
  theme_bw() +
  labs(title = "Distribution of Student")
```

```{r}
ggplot(numeric_of_intrst, aes(x=DEM_EDU)) + 
  geom_bar(fill = "turquoise") +
  theme_bw() +
  labs(title = "Distribution of Edu")
```

```{r}
ggplot(numeric_of_intrst, aes(x=DEM_INCOME)) + 
  geom_bar(fill = "turquoise") +
  theme_bw() +
  labs(title = "Distribution of Income")
```

```{r}
ggplot(numeric_of_intrst, aes(x=DEM_GENHEALTH)) + 
  geom_bar(fill = "turquoise") +
  theme_bw() +
  labs(title = "Distribution of Health Rating")
```
```{r}
ggplot(numeric_of_intrst, aes(x=STIM_USE)) + 
  geom_bar(fill = "turquoise") +
  theme_bw() +
  labs(title = "Distribution of Stim Use")
```



```{r}
ggplot(numeric_of_intrst, aes(x=STIM_NMU)) + 
  geom_bar(fill = "turquoise") +
  theme_bw() +
  labs(title = "Distribution of Stim Use")
```

## Model Selection

In order to make our model, we have decided to take a random sample of 10,000 to be sure that the model selection is accurate and not obscured by too many observations. 

```{r random-sample, message = FALSE}
set.seed(999) 
numeric_of_intrst <- numeric_of_intrst %>%
  sample_n(10000)
```

As we were interested in looking at variables that may help explain voter turnout, we started by considering all relevant predictor variables. We considered starting with a full model including sex, age, whether it was a Midterm or presidential election year, the year of the election, marital status, veteran status, citizenship status (native born or naturalized citizen), whether or not someone is Hispanic or Latinx, employment status, whether someone lives in a metropolitan area, highest education level attained, whether someone is a current student, and race.

Using the random sample of 10,000 observations, we began the model selection process using backwards selection using AIC criteria. See Appendix B for the full backward selection output and the full model output.

```{r}
# summary stats for numeric variables
numeric_of_intrst <- us_19_clean %>% 
  select(DEM_GENDER, DEM_AGE, DEM_INCOME, DEM_REGION,
         DEM_GENHEALTH, DEM_EDU, DEM_PREG, DEM_EDU, DEM_MARITAL, DEM_STDNT, STIM_USE, STIM_NMU, PAINREL_USE, PAINREL_NMU,
         SED_USE, SED_NMU, THC_USE, THC_NMU, OP_USE, OP_NMU, ALL_USE, ALL_NMU)%>% 
  mutate(DEM_MARITAL = factor(DEM_MARITAL),
         DEM_INCOME = factor(DEM_INCOME),
         DEM_GENDER = factor(DEM_GENDER),
         DEM_REGION = factor(DEM_REGION),
         DEM_GENHEALTH = factor(DEM_GENHEALTH),
         DEM_STDNT = factor(DEM_STDNT),
         DEM_EDU = factor(DEM_EDU),
         STIM_USE = factor(STIM_USE),
         STIM_NMU = factor(STIM_NMU),
         PAINREL_USE = factor(PAINREL_USE),
         PAINREL_NMU = factor(PAINREL_NMU),
         SED_USE = factor(SED_USE),
         SED_NMU = factor(SED_NMU),
         THC_USE = factor(THC_USE),
         THC_NMU = factor(THC_NMU),
         OP_USE = factor(OP_USE),
         OP_NMU = factor(OP_NMU),
         ALL_USE = factor(ALL_USE),
         ALL_NMU = factor(ALL_NMU)
         )

```


```{r backward-selection, include=FALSE}
int_only_model <- glm(STIM_USE ~ 1,
                     data = numeric_of_intrst,
                      family = "binomial")

full_model <- glm(STIM_USE ~ DEM_GENDER + DEM_AGE + WT + DEM_INCOME + DEM_REGION +
         DEM_GENHEALTH + DEM_EDU + DEM_STDNT + DEM_MARITAL,
                     data = numeric_of_intrst,
                      family = "binomial")

best_model_stimuse <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```

```{r tidy model, include=FALSE}
tidy(best_model_stimuse)
```

The final model included predictor variables for sex, whether someone between ages 18 and 24 is currently enrolled in school, citizenship status, employment status, race,  marital status, whether it was a presidential election year or a midterm election year, respondent age, and the highest education level of the respondent. 

The backward selection based on AIC removed the variables for the year, whether someone is from a metro area, veteran status, and hispanic status (see Appendix B).

```{r backward-selection, include=FALSE}
int_only_model <- glm(STIM_NMU ~ 1,
                     data = numeric_of_intrst,
                      family = "binomial")

full_model <- glm(STIM_NMU ~ DEM_GENDER + DEM_AGE + DEM_INCOME + DEM_REGION +
         DEM_GENHEALTH + DEM_EDU,
                     data = numeric_of_intrst,
                      family = "binomial")

best_model_stimnmu <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```

```{r}
tidy(best_model_stimnmu)
```
# Model for predicting whether or not a respondent uses the drug at all.
```{r ALL_USE}
int_only_model <- glm(ALL_USE ~ 1,
                     data = numeric_of_intrst,
                      family = "binomial")

full_model <- glm(ALL_USE ~ DEM_GENDER + DEM_AGE + DEM_INCOME + DEM_REGION +
         DEM_GENHEALTH + DEM_EDU + DEM_STDNT + DEM_MARITAL,
                     data = numeric_of_intrst,
                      family = "binomial")

best_model_alluse <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```


```{r}
tidy(best_model_alluse)
```

# Model for predicting whether or not a respondent misuses.
```{r}
int_only_model <- glm(ALL_NMU ~ 1,
                     data = numeric_of_intrst,
                      family = "binomial")

full_model <- glm(ALL_NMU ~ DEM_GENDER + DEM_AGE + DEM_INCOME + DEM_REGION +
         DEM_GENHEALTH + DEM_EDU + DEM_STDNT + DEM_MARITAL,
                     data = numeric_of_intrst,
                      family = "binomial")

best_model_allnmr <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```

```{r}
tidy(best_model_allnmr)
```

```{r}
#install.packages('jtools')
library(jtools)
```

```{r}
plot_summs(best_model_alluse, scale = TRUE, inner_ci_level = .95, colors = 'Qual3')
```

```{r}
plot_summs(best_model_allnmr, scale = TRUE, inner_ci_level = .95, colors = 'Qual2')
```


Gender, Age, Income, Region 4, 

```{r}
numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  group_by(DEM_INCOME) %>% 
  select(ALL_USE, ALL_NMU, DEM_INCOME) %>% 
  filter(ALL_NMU == 0) %>% # people who use drugs for medical purposes only.
  ggplot(aes(x = DEM_INCOME, y=..count../sum(..count..))) +
  geom_histogram(fill = "black") +
  theme_bw() + 
  labs(y = "Proportion of Misusers", title = "Income", 
       subtitle = "Respondents who used Prescription Drugs For Medical Purpose")
```
```{r}
numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  group_by(DEM_INCOME) %>% 
  select(ALL_USE, ALL_NMU, DEM_INCOME) %>% 
  # filter(ALL_NMU == 1) %>% # people who abuse prescription drugs
  ggplot(aes(x = DEM_INCOME, y=..count../sum(..count..), fill = ALL_NMU)) +
  geom_bar() +
  theme_bw() + 
  labs(y = 'Proportion of Users', title = "Income", 
       subtitle = "Respondents who Used/Misused Prescription Drugs") + 
  guides(fill=guide_legend(title="Misused the Prescription"))
```

```{r}
numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  group_by(DEM_INCOME) %>% 
  select(ALL_USE, ALL_NMU, DEM_INCOME) %>% 
  # filter(ALL_NMU == 1) %>% # people who abuse prescription drugs
  ggplot(aes(x = DEM_INCOME, y=..count../sum(..count..), fill = ALL_NMU)) +
  geom_bar(position="dodge") +
  theme_bw() + 
  labs(y = 'Proportion of Users', title = "Income", 
       subtitle = "Respondents who Used/Misused Prescription Drugs") + 
  guides(fill=guide_legend(title="Misused the Prescription"))
```

```{r}
numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  group_by(DEM_INCOME) %>% 
  select(ALL_USE, ALL_NMU, DEM_INCOME) %>% 
  # filter(ALL_NMU == 1) %>% # people who abuse prescription drugs
  ggplot(aes(x = DEM_INCOME, y=..count../sum(..count..), fill = ALL_NMU)) +
  geom_bar(position="fill") +
  theme_bw() + 
  labs(y = 'Proportion of Users', title = "Income", 
       subtitle = "Respondents who Used/Misused Prescription Drugs") + 
  guides(fill=guide_legend(title="Misused the Prescription"))
```

```{r}
numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  group_by(DEM_GENDER) %>% 
  # filter(ALL_NMU == 1) %>% # people who abuse prescription drugs
  ggplot(aes(x = DEM_GENDER, y=..count../sum(..count..), fill = ALL_NMU)) +
  geom_bar(position = 'fill') +
  theme_bw() + 
  labs(y = 'Proportion of Users', title = "Gender", 
       subtitle = "Respondents who Used/Misused Prescription Drugs") + 
  guides(fill=guide_legend(title="Misused the Prescription"))
```

```{r}
numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  group_by(DEM_GENDER) %>% 
  # filter(ALL_NMU == 1) %>% # people who abuse prescription drugs
  ggplot(aes(x = DEM_GENDER, y=..count../sum(..count..), fill = ALL_NMU)) +
  geom_bar(position = 'Dodge') +
  theme_bw() + 
  labs(y = 'Proportion of Users', title = "Gender", 
       subtitle = "Male Respondents More Likely to Misuse Prescription Drugs") + 
  guides(fill=guide_legend(title="Misused the Prescription"))
```

```{r}
numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  group_by(DEM_AGE) %>% 
  # filter(ALL_NMU == 1) %>% # people who abuse prescription drugs
  ggplot(aes(x = DEM_AGE, y=..count../sum(..count..), fill = ALL_NMU)) +
  geom_histogram(binwidth = 5) +
  theme_bw() + 
  labs(y = 'Proportion of Users', title = "Age", 
       subtitle = "Young Respondents More Likely to Misuse Prescription Drugs") + 
  guides(fill=guide_legend(title="Misused the Prescription"))
```

```{r}
numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  group_by(DEM_REGION) %>% 
  # filter(ALL_NMU == 1) %>% # people who abuse prescription drugs
  ggplot(aes(x = DEM_REGION, y=..count../sum(..count..), fill = ALL_NMU)) +
  geom_bar(position = "fill") +
  theme_bw() + 
  labs(y = 'Proportion of Users', title = "Region", 
       subtitle = "Region 4 (West) More Likely to Misuse Prescription Drugs") + 
  guides(fill=guide_legend(title="Misused the Prescription"))
```


# A model predicting whether or not respondent abuses the drug given that they use the drug.
# response NMU == 0 (medical use only) or 1 (non-medical use)



```{r}
DRUG_USE <- numeric_of_intrst %>% 
  filter(ALL_USE == 1)
```

```{r}
int_only_model <- glm(ALL_NMU ~ 1,
                     data = DRUG_USE,
                      family = "binomial")

full_model <- glm(ALL_NMU ~ DEM_GENDER + DEM_AGE + DEM_INCOME + DEM_REGION +
         DEM_GENHEALTH + DEM_EDU + DEM_STDNT + DEM_MARITAL,
                     data = DRUG_USE,
                      family = "binomial")

best_model_abuse_given_use <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```

```{r}
tidy(best_model_abuse_given_use, conf.int = TRUE)
```

```{r}
install.packages("Stat2Data")
library(Stat2Data)
emplogitplot1( ALL_NMU ~ DEM_AGE, data = numeric_of_intrst, 
              ngroups = 10, main = "Empirical Logit Plot For Age")
```

```{r}
plot_summs(best_model_abuse_given_use, scale = TRUE, inner_ci_level = .95, colors = 'Qual3')
```

Out of the respondents who have used presciption drugs during their lifetime, we found that age was a significant predictor of the odds of a respondent having also misused prescription drugs in their lifetime. For each additional year in age, the odds of a respondent having misused prescription drugs are expected to multiply by a factor of `r round(exp(-0.045126773), 3)` (p < 0.05), holding all other predictor variables constant. This may suggest that younger individuals are more likely to misuse the drug compared to older individuals given that they were prescribed the drug.

As we would expect, a key demographic that influences prescription drug misuse is gender. The odds of misuse for individuals who are females are expected to multiply by a factor of `r round(exp(-0.535022131), 3)` (p < 0.05) compared to individuals who are males, holding all else constant.

The coefficient associated with gender is a significant predictor of the odds of someone voting. The odds of voting for individuals who are divorced or separated are expected to multiply by a factor of `r round(exp(-0.710), 3)` (exp(-0.710),p < 0.05) compared to individuals who are married, holding all else constant. Similarly, the odds of voting for individuals who are not married/unknown are expected to multiply by a factor of `r round(exp(-0.477), 3)` (exp(-0.477), p < 0.05) compared to individuals who are married, holding all else constant.

As we would expect, a key demographic that influences voter turnout is age. For each additional year in age, the odds voting are expected to multiply by a factor of `r round(exp(0.040), 3)` (exp(0.040), p < 0.05), holding all other predictor variables constant.

We found that variables associated with race are significant predictors of the odds of voting during a Midterm election year. They differ in their relationship and magnitude, however. The following interpretations describe how the respective characteristics in our predictor variables affect the odds of voting during Midterm election years compared to a baseline of individuals who are White, holding all else constant:


In contrast to presidential years, the odds of voting for Black individuals are expected to multiply by a factor of `r round(exp(-0.494-1.152), 3)` (exp(-0.494-1.152), p < 0.05) compared to White individuals. The odds of voting for Asian or Pacific Islander individuals are expected to multiply by a factor of `r round(exp(0.630-1.152), 3)` (exp(0.630-1.152), p < 0.05) compared to White individuals. And, the odds of voting for individuals that are two or more races are expected to multiply by a factor of `r round(exp(0.836-1.152), 3)` (exp(0.836-1.152), p < 0.05) compared to White individuals.

The p-value for the coefficient related to Native American (p = 0.221) is greater than the alpha level of 0.05, indicating that there is not sufficient evidence that the odds of voting differ significantly between this population and White individuals, holding all else constant.


## FINAL_MODEL_START_HERE: Drug Misuse Given Drug Use (Grouped By US region_

## Northeast	1 (3534 respondents)
```{r}
DRUG_USE_1 <- numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  filter(DEM_REGION == 1)
```

## Midwest	2 (4,290 respondents)
```{r}
DRUG_USE_2 <- numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  filter(DEM_REGION == 2)
```

## South	3 (7,431 respondents)
```{r}
DRUG_USE_3 <- numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  filter(DEM_REGION == 3)
```

## West	4 (4,509 respondents)
```{r}
DRUG_USE_4 <- numeric_of_intrst %>% 
  filter(ALL_USE == 1) %>% 
  filter(DEM_REGION == 4)
```

```{r}
int_only_model <- glm(ALL_NMU ~ 1,
                     data = DRUG_USE_1,
                      family = "binomial")

full_model <- glm(ALL_NMU ~ DEM_GENDER + DEM_AGE + DEM_INCOME +
         DEM_GENHEALTH + DEM_EDU + DEM_STDNT + DEM_MARITAL,
                     data = DRUG_USE_1,
                      family = "binomial")

NORTH_EAST_MODEL <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```

```{r}
int_only_model <- glm(ALL_NMU ~ 1,
                     data = DRUG_USE_2,
                      family = "binomial")

full_model <- glm(ALL_NMU ~ DEM_GENDER + DEM_AGE + DEM_INCOME +
         DEM_GENHEALTH + DEM_EDU + DEM_STDNT + DEM_MARITAL,
                     data = DRUG_USE_2,
                      family = "binomial")

MID_WEST_MODEL <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```


```{r}
int_only_model <- glm(ALL_NMU ~ 1,
                     data = DRUG_USE_3,
                      family = "binomial")

full_model <- glm(ALL_NMU ~ DEM_GENDER + DEM_AGE + DEM_INCOME +
         DEM_GENHEALTH + DEM_EDU + DEM_STDNT + DEM_MARITAL,
                     data = DRUG_USE_3,
                      family = "binomial")

SOUTH_MODEL <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```


```{r}
int_only_model <- glm(ALL_NMU ~ 1,
                     data = DRUG_USE_4,
                      family = "binomial")

full_model <- glm(ALL_NMU ~ DEM_GENDER + DEM_AGE + DEM_INCOME +
         DEM_GENHEALTH + DEM_EDU + DEM_STDNT + DEM_MARITAL,
                     data = DRUG_USE_4,
                      family = "binomial")

WEST_MODEL <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")
```

```{r}
NE_COEF <- tidy(NORTH_EAST_MODEL, conf.int = TRUE) %>%
  mutate(REGION = "NE")
```


```{r}
ggplot(NE_COEF, aes(term, estimate))+
  geom_point()+
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high))+
  labs(title = "Coefficients of North East model")+
  coord_flip() +
  theme_bw() +
  labs(y = "Covariates of Interest")
```


```{r}
MW_COEF <- tidy(MID_WEST_MODEL, conf.int = TRUE) %>%
  mutate(REGION = "MW")
```

```{r}
ggplot(MW_COEF, aes(term, estimate))+
  geom_point()+
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high))+
  labs(title = "Coefficients of Mid-West model")+
  coord_flip() +
  theme_bw() +
  labs(y = "Covariates of Interest")
```


```{r}
SOUTH_COEF <- tidy(SOUTH_MODEL, conf.int = TRUE) %>% 
  mutate(REGION = "S")
```

```{r}
ggplot(SOUTH_COEF, aes(term, estimate))+
  geom_point()+
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high))+
  labs(title = "Coefficients of South model")+
  coord_flip() +
  theme_bw() +
  labs(y = "Covariates of Interest")
```

```{r}
WEST_COEF <- tidy(WEST_MODEL, conf.int = TRUE) %>% 
  mutate(REGION = "W")
```

```{r}
ggplot(WEST_COEF, aes(term, estimate))+
  geom_point()+
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high))+
  labs(title = "Coefficients of South model")+
  coord_flip() +
  theme_bw() +
  labs(y = "Covariates of Interest")
```

# Columns to be merged on
```{r}
MERGE_COLS <- c('term','estimate', 'statistic', 'conf.low', 'conf.high', 'p.value', 'REGION')
```


```{r}
WEST_SOUTH <- merge(WEST_COEF, SOUTH_COEF, by = MERGE_COLS, all = TRUE)
WSNE <- merge(WEST_SOUTH, NE_COEF, by = MERGE_COLS, all = TRUE)
ALL_REGIONS_TIDY <- merge(WSNE, MW_COEF, by = MERGE_COLS, all = TRUE)

ALL_REGIONS_TIDY <- ALL_REGIONS_TIDY %>% 
  select(term, estimate, statistic, conf.low, conf.high, p.value, REGION)
```

```{r fig.height = 6, fig.width = 9}
ggplot(ALL_REGIONS_TIDY, aes(y = estimate, x = term, color = REGION))+
  geom_point(size = 0.6) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high))+
  geom_hline(yintercept=0, linetype="dashed", color = "red")+
  coord_flip() +
  theme_bw() +
  labs(x = "Covariates of Interest", y = "Estimate", title = "Significant Logit Model Coefficients", subtitle = "By US Region")
```

```{r fig.height = 6, fig.width = 9}
tiff("ALL_REGIONS_TIDY.tiff", units="in", width=5, height=5, res=300)
# insert ggplot code
ggplot(ALL_REGIONS_TIDY, aes(y = estimate, x = term, color = REGION))+
  geom_point(size = 0.6) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high))+
  geom_hline(yintercept=0, linetype="dashed", color = "red")+
  coord_flip() +
  theme_bw() +
  labs(x = "Covariates of Interest", y = "Estimate", title = "Significant Logit Model Coefficients", subtitle = "By US Region")
dev.off()
```


## Interaction Terms

We will add in several interaction terms of interest and use a drop-in-deviance test to see if they are meaningful predictors of the odds of someone voting.

The reduced model is the same as the model titled "Model Resulting From Backward Selection," (see Appendix B) and the full model is the reduced model plus interactions terms for sex and employment, election type and highest education level, sex and election type, and race and election type.

The following hypotheses will be used:

$H_0$: the coefficients for the interaction between election type and highest education level, sex and election type, and race and election type are all zero.

$H_0:$

$\beta_{sex*employed} = \beta_{Election*highest_education} = \beta_{sex*Election} = \beta_{race*Election} = 0$

$H_a$: at least one of these coefficients for the interaction terms $\neq$ zero.

$\alpha = 0.05$

```{r interaction, include=FALSE}
reduced_model <- best_model

full_model <- glm(voted ~ sex + current_student + citizen + employed + 
                    race + marst + Election + AGE + 
                    highest_education +
                    Election*highest_education + 
                    sex*Election + 
                    race*Election,
                     data = elections_red,
                      family = "binomial")

```

```{r drop-in-deviance1}
anova(reduced_model, full_model, test = "Chisq") %>%
  tidy() %>% 
  kable(digits = 3, 
        caption = "Drop-In-Deviance Test Results For Interaction Terms")
```

```{r model-output-interaction, include=FALSE}
tidy(full_model) %>% 
  kable(digits = 3)
```



```{r data cleaning}
elections_clean <- elections %>% 
  mutate(metro = if_else(METRO == 2, "Metro", "Not Metro/Unknown")) %>% 
  mutate(sex = case_when(SEX == 1 ~ "Male",
                         SEX == 2 ~ "Female")) %>% 
  mutate(marst = case_when(MARST == 1 ~ "Married",
                           MARST == 2 ~ "Married",
                           MARST == 4 ~ "Divorced/Separated",
                           MARST == 3 ~ "Divorced/Separated",
                           TRUE ~ "Not Married/Other")) %>% 
  mutate(veteran = if_else(VETSTAT == 2, "Yes", "No/Uknnown")) %>% 
  mutate(citizen = case_when(CITIZEN == 5 | CITIZEN == 9 ~ "No/Unknown", 
                             CITIZEN == 1 | CITIZEN == 2 | CITIZEN == 3 ~ 
                               "Native Born",
                             CITIZEN == 4 ~ "Naturalized")) %>% 
  #There are no observations with 5 or 9 for citizen
  mutate(hispanic_status = if_else(HISPAN == 0 | HISPAN == 901 | HISPAN == 902, 
                             "Not Hispanic/Unknown", "Hispanic/Latinx")) %>% 
  mutate(employed = if_else(LABFORCE == 2, "Yes", "No/Unknown")) %>% 
  mutate(highest_education = case_when(EDUC99 == 0 | EDUC99 == 1 ~ 
                                         "None/Unknown",
                               EDUC99 == 4 | EDUC99 == 5 | EDUC99 == 6 |
                                 EDUC99 == 7 | EDUC99 == 8 | EDUC99 == 9
                               ~ "Some High School",
                               EDUC99 == 10 ~ "High School Degree/GED",
                               EDUC99 == 11 ~ "Some College",
                               EDUC99 == 12 | EDUC99 == 13 | EDUC99 == 14
                               ~ "Associate Degree",
                               EDUC99 == 15 ~ "Bachelors Degree",
                               EDUC99 == 16 ~ "Masters Degree",
                               EDUC99 == 17 ~ "Professional Degree",
                               EDUC99 == 18 ~ "Doctorate Degree")) %>% 
  mutate(current_student = case_when(SCHLCOLL == 5 | SCHLCOLL == 0 ~ 
                                       "Not currently enrolled",
                                     SCHLCOLL == 1  ~ "High School Full Time",
                                     SCHLCOLL == 2 ~ "High School Part Time",
                                     SCHLCOLL == 3 ~ "College Full Time",
                                     SCHLCOLL == 4 ~ "College Part Time")) %>% 
#of people 16-24
  mutate(race = case_when(RACE == 820 | RACE == 830 | RACE == 830 | RACE == 819 
                          | RACE == 804 | RACE == 805 | RACE == 806 | 
                            RACE == 807 | RACE == 808 | RACE == 810 | 
                            RACE == 811 | RACE == 812 | RACE == 813 | 
                            RACE == 814 | RACE == 815 | RACE == 816 | 
                            RACE == 817 | RACE == 818 | RACE == 803 | 
                            RACE == 801 | RACE == 802 | RACE == 830 ~ 
                            "2 or more races",
                          RACE == 100 ~ "White",
                          RACE == 200 ~ "Black",
                          RACE == 651 | RACE == 809 | RACE == 652 | RACE == 650
                          ~ "Asian or Pacific Islander",
                          RACE ==  300 ~ "Native American",
                          RACE == 999 | RACE == 700 ~ "Other/Unknown")) %>% 
  #Need to go over these race categorizations as a group!
  mutate(why_not_vote = case_when(VOWHYNOT == 10 ~ "Inconvenience",
                                  VOWHYNOT == 4 ~ "Interest",
                                  VOWHYNOT == 7 ~ "Political",
                                  VOWHYNOT == 9 | VOWHYNOT ==  6 | 
                                    VOWHYNOT == 5 | VOWHYNOT == 2 ~ 
                                    "Logistical",
                                  VOWHYNOT == 1 ~ "Physically Unable",
                                  VOWHYNOT == 8 ~ "Registration Issues",
                                  VOWHYNOT == 3 ~ "Forgot")) %>% 
#Reason why eligible voter did not vote
  mutate(why_not_reg = case_when(VOYNOTREG == 8 | VOYNOTREG == 3 ~ 
                                   "Not Eligible",
                                 VOYNOTREG == 7 | VOYNOTREG == 6 ~ 
                                   "Not Interested/Vote Won't Matter",
                                 VOYNOTREG == 5 ~ "Language Barrier",
                                 VOYNOTREG == 4 ~ "Physically Unable",
                                 VOYNOTREG == 2 | VOYNOTREG == 1 ~ 
                                   "Lacked Info/Missed Deadline")) %>% 
  mutate(voting_method = case_when(VOTEHOW == 1 ~ "In Person",
                                   VOTEHOW == 2 ~ "Mail-In")) %>% 
  mutate(voting_time = case_when(VOTEWHEN == 2 ~ "Early",
                                 VOTEWHEN == 1 ~"Voting Day")) %>% 
  mutate(voted = case_when(VOTED == 1 ~ 0,
                           VOTED == 2 ~ 1)) %>% 
  mutate(registered = case_when(VOREG == 1 ~ 0,
                           VOREG == 2 ~ 1)) %>% 
  mutate(how_registered = case_when(VOREGHOW == 8 ~ "Online",
                                    VOREGHOW == 7 ~ "Polling Place",
                                    VOREGHOW == 6 ~ "Registration Drive",
                                    VOREGHOW == 5 | VOREGHOW == 2 | 
                                      VOREGHOW == 1 ~ 
                                      "Govt Office/Public Agency",
                                    VOREGHOW == 4 ~ "School/College/Hospital",
                                    VOREGHOW == 3 ~ "By Mail")) %>% 
  mutate(Election = case_when(YEAR %in% c(2004, 2008, 2012, 2016) ~ 
                                                    "Presidential",
                                                  YEAR %in% c(2006, 2010, 2014, 
                                                              2018) ~ 
                                                    "Midterm"),
         Election = factor(Election)) %>% 
    # mutate(Is_Presidential_Election = case_when(YEAR %in% c(2004, 2008, 
    #                                                       2012, 2016) ~ 
    #                                                 "Presidential",
    #                                               YEAR %in% c(2006, 2010, 2014, 
    #                                                           2018) ~ 
    #                                    "Non-Presidential"),
         # Is_Presidential_Election = factor(Is_Presidential_Election)) %>% 
  select(metro, sex, marst, veteran, citizen, hispanic_status, employed, 
         highest_education, current_student, race, why_not_vote, why_not_reg,
         voting_method, voting_time, voted, registered, how_registered, YEAR,
         STATEFIP, AGE, Election)

elections_clean <- elections_clean %>% 
  mutate(metro = factor(metro),
         sex = factor (sex),
         marst = factor(marst),
         veteran = factor(veteran),
         citizen = factor(citizen),
         hispanic_status = factor( hispanic_status),
         employed = factor(employed),
         highest_education = factor(highest_education),
         current_student = factor(current_student),
         race = factor(race),
         why_not_vote = factor(why_not_vote),
         why_not_reg = factor(why_not_reg),
         voting_method = factor(voting_method),
         voting_time = factor(voting_time),
         voted = factor(voted),
         registered = factor(registered),
         how_registered = factor(how_registered))

```

```{r relevel-factors}
elections_clean <- elections_clean %>% 
  mutate(marst = fct_relevel(marst, c("Married", "Divorced/Separated", 
                                      "Not Married/Other")),
         citizen = fct_relevel(citizen, c("Native Born", "Naturalized", 
                                      "No/Unknown")),
         highest_education = fct_relevel(highest_education, 
                                         c("Bachelors Degree", 
                                           "High School Degree/GED",
                                           "Some College",
                                           "Some High School", 
                                           "Associate Degree",
                                           "Masters Degree",
                                           "Professional Degree",
                                           "Doctorate Degree",
                                           "None/Unknown")),
         current_student = fct_relevel(current_student, 
                                       c("Not currently enrolled",
                                         "High School Full Time", 
                                         "High School Part Time",
                                         "College Full Time", 
                                         "College Part Time")),
         race = fct_relevel(race, c("White","Black","Asian or Pacific Islander", 
                                    "Native American", "2 or more races", 
                                    "Other/Unknown")),
         Election = fct_relevel(Election, 
                    c("Presidential", "Midterm")))
```

# Introduction and Data

  
*EDA*
We will begin our EDA by visualizing the relationship between the response variable describing whether or not someone voted and several of the other variables of particular interest. Every vote matters, so we want to make sure no one gets left behind!  

First, we will simply look at the distribution of those who voted throughout the last 8 years of elections.


```{r EDA, fig.height=3, fig.width=5, fig.align='center'}
response_plot <- ggplot(data = elections_clean, aes(x = voted, 
                                                    fill = "gainsboro")) +
  geom_bar() +
  theme_bw() +
  # see theme code inspiration at reference 1 
  theme(plot.title= element_text(face="bold", color = "Navy Blue"),
        plot.subtitle = element_text(face = 4, color = "grey54"),
        panel.grid.major = element_line(color = "Navy Blue", size=.1),
        legend.position = "none") +
  # see scale fill code inspiration at reference 2
  scale_fill_manual(values = c("gainsboro")) +
  labs(title = "Visualizing the Distribution of Voting Status", y = "Count",
       x = "Voted", subtitle = "More people reportedly voted than did not vote",
       caption = "0 = Did not Vote, 1 = Voted")
response_plot
```

*see theme code inspiration at reference [6]*
*see scale fill code inspiration at reference [7]*

From the barplot above, it is clear that more individuals in the data set voted (voted = 1) than did not (voted = 0).

Many political nonprofits engage with college campuses, so we want to analyze whether or not being a student influences the frequency of voting. We will explore this in a preliminary analysis by visualizing the distribution of whether school-aged individuals (18-24) voted or not -- categorized by their current student level. This is seen in the bar plot below.

```{r EDA1, fig.height=3, fig.width=5, fig.align='center'}
EDA1 <- elections_clean %>% 
  ggplot(aes(x = voted, fill = current_student)) +
  geom_bar() +
  theme_bw() +
  theme(plot.title= element_text(face="bold", color = "Navy Blue"),
        plot.subtitle = element_text(face = 4, color = "grey54"),
        panel.grid.major = element_line(color = "Navy Blue", size=.1))+
  #see scale fill brewer code inspiration from reference 1
  scale_fill_brewer(palette = "Blues") +
  labs(title = "Voting Distribution of 18-24 Year Olds", 
       y = "Count", x = "Voted", 
       subtitle = "Examining relationship between student status and voting",
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Current Student Status")
EDA1
```

*see scale fill brewer code inspiration from reference [6]*

From the bar plot, it is evident that a majority of these individuals were not currently enrolled. This may be a result of a general national trend, but we want to investigate if it is the result of a larger proportion of older individuals (aged 23-24) within in the range of ages between 18 and 24. We will investigate this by analyzing those who are not currently enrolled in school within this age range.

```{r age-distribution-college-aged}
elections_clean %>%
  filter(current_student == "Not currently enrolled") %>%
  filter(AGE >=16 & AGE <=24) %>%
  group_by(AGE) %>%
  count()  %>% 
  ungroup() %>%
  mutate(prop = n/sum(n)) %>%
  kable(digits = 3, 
  caption = "Proportion of Respondents Not Currently Enrolled In School By Age")
```

From the table above, it is apparent that more than 40% of those not currently enrolled in school are 23-24 years old. This could be a potential reason for why this age range includes so many who are not currently enrolled as a student. 

To more meaningfully analyze the relationship between being a student and if they vote or not, we adjusted our visualization to only include those currently enrolled in some level of education. This is seen in the visualization below. 

```{r EDA2, fig.height=3, fig.width=5, fig.align='center'}
EDA2 <- elections_clean %>% 
  filter(current_student != "Not currently enrolled") %>% 
  ggplot(aes(x = voted, fill = current_student)) +
  geom_bar() +
  theme_bw() +
    theme(plot.title= element_text(face="bold", color = "Navy Blue"),
        plot.subtitle = element_text(face = 4, color = "grey54"),
        panel.grid.major = element_line(color = "Navy Blue", size=.1))+
  scale_fill_brewer(palette="Blues") +
  labs(title = "Voting Distribution of 18-24 Year Olds \nEnrolled in School", 
       y = "Count", x = "Voted", 
       subtitle = "Examining relationship between student status and voting",
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Current Student Status")
EDA2
```

This visualization shows that respondents between the age 18 and 24 enrolled in some education at the time were mainly full time college students. More full time and part time college students that were eligible to vote did vote compared to those that did not vote. The opposite is true for high school students: more full time and part time high school students that were eligible to vote did not vote compared to those that did vote. 

Next we will consider the voting distributian based on citizen status.

```{r EDA3, fig.height=3, fig.width=5, fig.align='center'}
citizen_plot <- elections_clean %>% 
  group_by(citizen) %>% 
  count(voted) %>% 
  mutate(total = sum(n)) %>% 
  mutate(prop = n/total) %>% 
  mutate(prop = round(prop, 3))

citizen_plot %>% 
  ggplot(aes(x = voted, y = prop, fill = citizen)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = prop), vjust = 0.5) + 
  #see geom_text() code inspiration in reference [4]*
  facet_wrap(vars(citizen))+
  scale_fill_brewer(palette = "Blues") +
  labs(title = "Voting Distribution Based on Citizenship Status", 
       y = "Proportion", x = "Voted", 
     subtitle = "Examining relationship between citizenship status and voting",
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Citizenship Status") +
  theme_bw()
```

*see geom_text() code inspiration in reference [8]*

This visualization shows that for both randomly sampled native born and naturalized individuals, more citizens voted than did not; however, the proportion is much greater for native born citizens than for naturalized. For a similar plot comparing respondents by veteran status, please consult Appendix A.

Next we will consider the voting distributian based on age. It has previously been shown that age has an effect on voting.

```{r EDA4, fig.height=3, fig.width=5, fig.align='center'}
elections_clean %>% 
  ggplot(aes(x = AGE, y = voted)) +
  geom_boxplot(fill = "gray") +
  coord_flip() +
  labs(title = "Relationship Between Age and Voting", 
       y = "Voting Status", x = "Age", 
       caption = "0 = Did not Vote, 1 = Voted",
       fill = "Citizenship Status")+
  theme_bw()

```

This box plot shows that respondents that did vote were generally older than respondents that did not vote.

We are also interested in looking at how voter turnout has changed over the
years.

```{r year-voting-frequency}
elections_year <- elections_clean %>% 
  group_by(YEAR) %>% 
  count(voted) %>% 
  mutate(prop_voted = n/sum(n))
```

We notice that the proportion of people who voted fluctuates depending on whether the year falls on a presidential election. In the trend of the proportion of voting over time, we see a clear divide between voting depending on presidential election year. However, ranges including the interquartile range of the boxplots overlap. In the future, we may decide to add the variable "Election Year" as an interaction term in the model.

```{r EDA6, fig.height=3, fig.width=4.5, fig.align='center'}
elections_year %>% 
  filter(voted == 1) %>% 
  ggplot(aes(x = YEAR, y = prop_voted)) +
  geom_point() +
  labs(title = "Visualizing Proportion of Voters Over Time", 
       y = "Proportion of People Who Voted", x = "Year")
```

We decided to look at the scatterplot of voter turnout over time broken down by the status of the election (Presidential election, midterm after incumbent president, or midterm after new president) to see how it may differ depending on the election.

```{r scatterplot-over-time, fig.height=3, fig.width=6, fig.align='center'}
elections_year %>% 
  mutate(Election_new = case_when(YEAR %in% c(2004, 2008, 
                                                          2012, 2016) ~ 
                                                    "Presidential",
                                                  YEAR %in% c(2006, 2014) ~ 
                                       "Midterm Following Incumbent President",
                                          YEAR %in% c(2010, 2018) ~ 
                                          "Midterm Following New President"),
        Election_new = factor(Election_new)) %>% 
  filter(voted == 1) %>% 
  ggplot(aes(x = YEAR, y = prop_voted, color = Election_new)) +
  geom_point() +
  labs(title = "Higher Proportion of Voters During Presidential Election Years", 
       y = "Proportion of People Who Voted", x = "Year", 
       color = "Presidential Election Year", caption = "1: Yes; 0: No")
```

From the above scatterplot, we confirmed that there is higher voter turnout during presidential elections compared to midterm elections. In addition, there is equal or higher voter turnout for midterm elections following the election of a new president compared to midterm elections following the election of an incumbent president, and an especially high voter turnout in the midterm election after Trump's election in 2016. We also noticed the two midterm types are similar, so we will combine the two midterms into one variable should we use it as an interaction term.

Finally, it is important to acknowledge the missingness in our data, as it may influence the outcome of our regression analysis. The initial data sourced from the "This Is Statistics: Fall Data Challenge" used non-uniform values for the different variables, therefore we cleaned the data to be more intelligible for our analysis. While cleaning, we did impute "NA" values by either combining them with other categories and/or removing them to improve our analysis. We believe this will not negatively affect our analysis, yet we will move forward taking it into consideration. 

After analyzing these preliminary visualizations and observations, we will now begin to build our model. 

# Methodology

This data set was originally coded with different numerical values which would 
have made analysis difficult. Therefore, we re-coded the data to make it more 
intelligible by using the codebook provided with the data download on 
Google Drive [1]. This was done in the data cleaning process by 
re-coding the numerical values into string identifiers or binary numerical 
identifiers. The new dataset, `elections_clean`, is too large to load into the 
data folder and push to github, so we have included the raw dataset in the data
folder, and the cleaned data-set can be attained by running the code in the Rmd.

The primary response variable of our regression analysis will be whether or not
someone voted, the variable called `voted`. The variable `voted` is 
a categorical variable that identifies whether or not a respondent
voted in the most recent November election. Hence, we used a logistic 
regression model for the binary response.

## Model Selection

In order to make our model, we have decided to take a random sample of 10,000 to be sure that the model selection is accurate and not obscured by too many observations. 

```{r random-sample, message = FALSE}
set.seed(6687) 
elections_red <- elections_clean %>%
  sample_n(10000)
```

As we were interested in looking at variables that may help explain voter turnout, we started by considering all relevant predictor variables. We considered starting with a full model including sex, age, whether it was a Midterm or presidential election year, the year of the election, marital status, veteran status, citizenship status (native born or naturalized citizen), whether or not someone is Hispanic or Latinx, employment status, whether someone lives in a metropolitan area, highest education level attained, whether someone is a current student, and race.

Using the random sample of 10,000 observations, we began the model selection process using backwards selection using AIC criteria. See Appendix B for the full backward selection output and the full model output.



```{r backward-selection, include=FALSE}
int_only_model <- glm(voted ~ 1,
                     data = elections_red,
                      family = "binomial")

full_model <- glm(voted ~ metro + sex + marst + veteran+ citizen + 
                   hispanic_status + employed + highest_education + 
                   current_student + race + AGE + Election
                 + YEAR,
                     data = elections_red,
                      family = "binomial")

best_model <- step(full_model, scope=formula(int_only_model), 
                   direction = "backward")

```

```{r tidy model, include=FALSE}
tidy(best_model) %>% 
  kable(digits = 3, caption = "Model Resulting From Backward Selection")
```

The final model included predictor variables for sex, whether someone between ages 18 and 24 is currently enrolled in school, citizenship status, employment status, race,  marital status, whether it was a presidential election year or a midterm election year, respondent age, and the highest education level of the respondent. 

The backward selection based on AIC removed the variables for the year, whether someone is from a metro area, veteran status, and hispanic status (see Appendix B).


## Interaction Terms

We will add in several interaction terms of interest and use a drop-in-deviance test to see if they are meaningful predictors of the odds of someone voting.

The reduced model is the same as the model titled "Model Resulting From Backward Selection," (see Appendix B) and the full model is the reduced model plus interactions terms for sex and employment, election type and highest education level, sex and election type, and race and election type.

The following hypotheses will be used:

$H_0$: the coefficients for the interaction between election type and highest education level, sex and election type, and race and election type are all zero.

$H_0:$

$\beta_{sex*employed} = \beta_{Election*highest_education} = \beta_{sex*Election} = \beta_{race*Election} = 0$

$H_a$: at least one of these coefficients for the interaction terms $\neq$ zero.

$\alpha = 0.05$

```{r interaction, include=FALSE}
reduced_model <- best_model

full_model <- glm(voted ~ sex + current_student + citizen + employed + 
                    race + marst + Election + AGE + 
                    highest_education +
                    Election*highest_education + 
                    sex*Election + 
                    race*Election,
                     data = elections_red,
                      family = "binomial")

```

```{r drop-in-deviance1}
anova(reduced_model, full_model, test = "Chisq") %>%
  tidy() %>% 
  kable(digits = 3, 
        caption = "Drop-In-Deviance Test Results For Interaction Terms")
```

```{r model-output-interaction, include=FALSE}
tidy(full_model) %>% 
  kable(digits = 3)
```


The p-value (approximately 0) is very small (less than the alpha level 0.05), 
so we can reject the null hypothesis. Thus, we conclude that the data provide 
sufficient evidence that at least one of the coefficients associated with the additional 
interaction terms is not equal to 0. Therefore, we should add them to the model. 
See Appendix C for the full model output resulting from the additional interaction terms.


```{r resulting-model}
reduced_model <- best_model

full_model <- glm(voted ~ sex + current_student + citizen + employed + 
                    race + marst + Election + AGE + 
                    highest_education +
                    Election*highest_education + 
                    sex*Election + 
                    race*Election,
                     data = elections_red,
                      family = "binomial")
```

We will use a drop-in-deviance test to determine whether or not sex is a 
meaningful predictor of the odds of someone voting.

The following hypotheses will be used:

$H_0$: the coefficients for the main effect for sex and the interaction between sex and election type are all zero. All of the coefficients associated with sex are equal to zero.

$H_0:$ $\beta_{sex} =\beta_{sex*employed} = \beta_{sex*Presidential-Election-Status} = 0$

$H_a$: at least one of these coefficients for the coefficients associated with sex $\neq$ zero

$\alpha = 0.05$

```{r model-with-sex}
sex_included <- glm(voted ~ sex + current_student + citizen + employed + 
                    race + marst + Election + AGE + 
                    highest_education +
                    Election*highest_education + 
                    sex*Election + 
                    race*Election,
                     data = elections_red,
                      family = "binomial")

sex_excluded <- glm(voted ~ current_student + citizen + employed + 
                    race + marst + Election + AGE + 
                    highest_education +
                    Election*highest_education + 
                    race*Election,
                     data = elections_red,
                      family = "binomial")
```


```{r drop-in-deviance2}
anova(sex_excluded, sex_included, test = "Chisq") %>%
  tidy() %>% 
  kable(digits = 3, caption = "Drop-In-Deviance Test Results For Sex")
```

From the drop-in-deviance test used to determine if we should include variable sex, the p-value (0.138) is greater than an alpha-level of 0.05, so we will exclude the main effect for sex and the interaction terms including sex from the model. This contradicts the AIC results from the backward selection that determined that we should keep sex in the model, which is most likely due their different criteria for statistical significance. Backward selection makes decisions based on the AIC, while the drop-in-deviance test uses the p-value. A potential discrepancy between the two values may have resulted in the different determinations of the significance of sex. We have chosen to use the results of the drop-in-deviance test, and therefore, will be excluding sex from the final model.
